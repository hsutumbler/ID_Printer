# GNT 健保卡讀取整合說明

## 概述

本程式已成功整合 GNT 醫院抽血櫃台程式的健保卡讀取功能，支援離線模式運作，可在資訊系統當機時作為備援使用。

## 主要功能

### 1. 智慧 DLL 偵測
- **優先搜尋順序：**
  1. `GNT/HenCs/NhiCard.dll` (主要 GNT 路徑)
  2. `GNT/HenCs1/NhiCard.dll` (備用 GNT 路徑)  
  3. `GNT/kanban/NhiCard.dll` (看板系統路徑)
  4. `C:\NHI\LIB\csHis50.dll` (健保署官方路徑)

### 2. 離線模式支援
- **自動啟用條件：** 當找不到可用的健保卡 DLL 時
- **功能特色：**
  - 簡化的錯誤訊息，專注於硬體檢查
  - 支援自動列印標籤
  - 記錄操作標示為「離線模式」

### 3. 增強的資料處理
- **支援 GNT 資料格式：**
  - 身分證字號 (`ID_NUMBER`)
  - 姓名 (`FULL_NAME`)
  - 出生日期 (`BIRTH_DATE`) - 支援西元年和民國年格式
  - 性別 (`SEX`) - 自動標準化為「男」/「女」

### 4. COM 埠設定
- **預設設定：** COM1
- **可調整：** 在 `config.ini` 中修改 `com_port` 參數

## 設定檔說明

### config.ini 新增項目

```ini
[健保卡設定]
# 讀卡機 COM 埠設定 (參考 GNT 的 CardPortSet.xml)
com_port = 1

# 離線模式設定
offline_mode = true
offline_auto_print = true
```

## 使用方式

### 正常運作環境（醫院內）
1. 確保 GNT 程式已正確安裝
2. 健保卡讀卡機已連接至 COM1
3. 啟動程式，會自動偵測並使用 GNT DLL
4. 插入健保卡，點擊「讀取健保卡」

### 離線模式（系統當機時）
1. 程式會自動切換至離線模式
2. 狀態列顯示「離線模式已啟用」
3. 插入健保卡，點擊「讀取健保卡」
4. 如啟用自動列印，會在讀取成功後自動印出標籤

## 錯誤處理

### GNT DLL 相關錯誤
- **COM 物件建立失敗：** 正常現象，GNT DLL 需要在醫院環境中註冊
- **DLL 載入失敗：** 程式會自動切換至離線模式

### 離線模式錯誤訊息
簡化的故障排除指引：
1. 確認健保卡已正確插入讀卡機
2. 確認讀卡機已連接並開啟電源  
3. 確認 COM 埠設定正確
4. 重新插拔健保卡再試

## 技術細節

### GNT DLL 整合方式
- **偵測方式：** 檢查檔案路徑是否包含 "NhiCard.dll"
- **載入方式：** 
  - 優先嘗試 COM 介面 (`win32com.client.Dispatch("NhiCard.Patient")`)
  - COM 失敗時提供明確錯誤訊息
- **資料取得：** 透過 COM 物件的屬性方法

### 相容性
- **支援 GNT COM 介面：** `GetPatientIdCard`, `GetPatientName`, `GetPatientSex`
- **支援標準健保署 DLL：** 傳統 ctypes 呼叫方式
- **向下相容：** 保持原有功能不變

## 部署建議

### 醫院環境部署
1. 將程式放置於有 GNT 程式的電腦上
2. 確保 `GNT` 資料夾與程式在同一目錄
3. 檢查讀卡機 COM 埠設定
4. 測試讀卡功能

### 備援使用
1. 當主要資訊系統當機時啟動此程式
2. 程式會自動進入離線模式
3. 可繼續讀取健保卡並印出標籤
4. 所有操作會記錄在 `records` 資料夾中

## 記錄檔

所有操作都會記錄在以下位置：
- **應用程式記錄：** `logs/app_log.log`
- **病人記錄：** `records/record_YYYYMMDD.csv`
- **離線模式標示：** 操作類型會標註「(離線模式)」

## 故障排除

### 常見問題
1. **找不到 GNT DLL：** 檢查 GNT 程式是否已安裝
2. **COM 埠錯誤：** 修改 `config.ini` 中的 `com_port` 設定
3. **讀卡失敗：** 檢查讀卡機連接和健保卡狀態

### 聯繫支援
如遇到問題，請聯繫醫院 IT 部門，並提供：
- 錯誤訊息截圖
- `logs/app_log.log` 檔案
- GNT 程式安裝狀態
